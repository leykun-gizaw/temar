services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      target: deps # <-- Builds only the 'deps' stage with node_modules

    # Override the command to run the dev server
    command: pnpm nx serve web --host=0.0.0.0 --port=5173

    volumes:
      # Mount the entire monorepo into the container
      - .:/app
      # Add anonymous volumes for files/folders we DON'T want
      # to overwrite from the host. This keeps the container's
      # node_modules and lets Nx cache things inside the container.
      - dev_node_modules:/app/node_modules
      - dev_dist:/app/dist
      - dev_tmp:/app/tmp
      - dev_nx_cache:/app/.nx/cache

    # Keep restart policy 'no' for development
    restart: "no"
    depends_on:
      migrate:
        condition: service_completed_successfully

  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      target: deps
    volumes:
      - .:/app
      - dev_node_modules:/app/node_modules
      - dev_dist:/app/dist
      - dev_tmp:/app/tmp
      - dev_nx_cache:/app/.nx/cache
    command: ["pnpm", "nx", "run", "db-client:migrate:dev"]
    depends_on:
      db:
        condition: service_healthy

  db:
    ports:
      # Expose the DB port ONLY in development
      # for tools like DBeaver or TablePlus
      - "5432:5432"

  adminer:
    image: adminer
    restart: "unless-stopped"
    ports:
      - "8080:8080"
    depends_on:
      - db
    networks:
      - dokploy-network

volumes:
  dev_node_modules:
  dev_dist:
  dev_tmp:
  dev_nx_cache:
